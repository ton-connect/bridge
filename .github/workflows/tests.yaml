name: tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

    
jobs:
  unit:
     name: unit
     runs-on: ubuntu-latest
     steps:

     - name: Check out code
       uses: actions/checkout@v5

     - name: unit tests
       run: make test

  integration:
    name: integration-${{ matrix.storage }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        storage: [memory, postgres, valkey, nginx, dnsmasq, sharded-valkey]

    steps:
    - uses: actions/checkout@v5

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Start bridge
      run: docker compose -f docker/docker-compose.${{ matrix.storage }}.yml up --build -d bridge

    - name: Run bridge-sdk tests
      id: bridge_sdk_tests
      run: |
        docker compose -f docker/docker-compose.${{ matrix.storage }}.yml run --rm integration || rc=$?
        rc=${rc:-0}
        echo "sdk_rc=$rc" >> $GITHUB_OUTPUT
        if [ $rc -ne 0 ]; then
          echo "Bridge SDK tests failed with exit code $rc"
        fi

    - name: Run go-integration tests
      id: go_integration_tests
      run: |
        docker compose -f docker/docker-compose.${{ matrix.storage }}.yml run --rm gointegration || rc=$?
        rc=${rc:-0}
        echo "go_rc=$rc" >> $GITHUB_OUTPUT
        if [ $rc -ne 0 ]; then
          echo "Go integration tests failed with exit code $rc"
        fi

    - name: Get performance metrics
      if: github.event_name == 'pull_request'
      run: |
        ./scripts/pr-metrics.sh "${{ matrix.storage }}" > metrics-${{ matrix.storage }}.md

    - name: Upload metrics artifact
      if: github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: metrics-${{ matrix.storage }}
        path: metrics-${{ matrix.storage }}.md
        retention-days: 1

    - name: Clean up containers
      if: always()
      run: docker compose -f docker/docker-compose.${{ matrix.storage }}.yml down -v

    - name: Fail job if any tests failed
      if: ${{ fromJSON(steps.bridge_sdk_tests.outputs.sdk_rc) != 0 || fromJSON(steps.go_integration_tests.outputs.go_rc) != 0 }}
      run: |
        echo "Test failures detected:"
        echo "  Bridge SDK tests: exit code ${{ steps.bridge_sdk_tests.outputs.sdk_rc }}"
        echo "  Go integration tests: exit code ${{ steps.go_integration_tests.outputs.go_rc }}"
        exit 1

  comment-metrics:
    name: Comment Performance Metrics
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: integration
    steps:
      - name: Download all metrics artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: metrics-*
          path: metrics

      - name: Combine metrics
        run: |
          echo "# ðŸ“Š Performance Metrics" > combined-metrics.md
          echo "" >> combined-metrics.md
          echo "_Updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')_" >> combined-metrics.md
          echo "" >> combined-metrics.md
          
          for storage in memory postgres valkey nginx dnsmasq sharded-valkey; do
            if [ -f "metrics/metrics-${storage}/metrics-${storage}.md" ]; then
              cat "metrics/metrics-${storage}/metrics-${storage}.md" >> combined-metrics.md
              echo "" >> combined-metrics.md
            fi
          done

      - name: Comment PR
        uses: mshick/add-pr-comment@v2
        with:
          message-path: combined-metrics.md
          message-id: performance-metrics-combined

